# Лабораторная работа №20: Работа с файлами

## Теория

### Работа с файлами в C#

Работа с файлами - это важная часть программирования, которая включает чтение, запись, поиск и управление файлами в файловой системе.

#### Основные классы для работы с файлами

```csharp
// File - статические методы для работы с файлами
File.ReadAllText("file.txt");
File.WriteAllText("file.txt", "content");
File.Exists("file.txt");

// FileInfo - объектно-ориентированный подход
var fileInfo = new FileInfo("file.txt");
fileInfo.Length; // размер файла
fileInfo.CreationTime; // дата создания
fileInfo.Attributes; // атрибуты файла

// Directory - работа с директориями
Directory.GetFiles("path", "*.txt");
Directory.CreateDirectory("new_folder");

// Path - работа с путями
Path.Combine("folder", "file.txt");
Path.GetExtension("file.txt");
Path.GetFileName("path/to/file.txt");
```

#### Чтение и запись файлов

```csharp
// Чтение всего файла
string content = File.ReadAllText("input.txt");
string[] lines = File.ReadAllLines("input.txt");

// Запись в файл
File.WriteAllText("output.txt", "Hello World");
File.WriteAllLines("output.txt", new[] { "Line 1", "Line 2" });

// Асинхронные операции
await File.ReadAllTextAsync("input.txt");
await File.WriteAllTextAsync("output.txt", "content");
```

#### Поиск в файлах

```csharp
// Поиск строк, содержащих определенное слово
var lines = File.ReadAllLines("input.txt");
var matchingLines = lines.Where(line => line.Contains("search"));

// Поиск с регулярными выражениями
using System.Text.RegularExpressions;
var regex = new Regex(@"\b\d{3}-\d{3}-\d{4}\b"); // телефонный номер
var phoneLines = lines.Where(line => regex.IsMatch(line));

// Поиск строк, заканчивающихся на определенное слово
var endingLines = lines.Where(line => line.EndsWith("end"));
```

### Атрибуты файлов

#### Типы атрибутов
```csharp
FileAttributes attributes = File.GetAttributes("file.txt");

// Проверка атрибутов
if ((attributes & FileAttributes.ReadOnly) == FileAttributes.ReadOnly)
{
    Console.WriteLine("Файл только для чтения");
}

if ((attributes & FileAttributes.Hidden) == FileAttributes.Hidden)
{
    Console.WriteLine("Файл скрыт");
}

if ((attributes & FileAttributes.Archive) == FileAttributes.Archive)
{
    Console.WriteLine("Файл архивный");
}
```

#### Изменение атрибутов
```csharp
// Установка атрибута "Только для чтения"
File.SetAttributes("file.txt", FileAttributes.ReadOnly);

// Снятие атрибута "Только для чтения"
var attributes = File.GetAttributes("file.txt");
File.SetAttributes("file.txt", attributes & ~FileAttributes.ReadOnly);

// Установка нескольких атрибутов
File.SetAttributes("file.txt", FileAttributes.Hidden | FileAttributes.ReadOnly);
```

### FileSystemWatcher

#### Настройка отслеживания
```csharp
var watcher = new FileSystemWatcher("path/to/watch")
{
    NotifyFilter = NotifyFilters.FileName | NotifyFilters.DirectoryName | NotifyFilters.LastWrite,
    Filter = "*.txt",
    IncludeSubdirectories = true,
    EnableRaisingEvents = true
};
```

#### Обработчики событий
```csharp
// Создание файла
watcher.Created += (sender, e) =>
{
    Console.WriteLine($"Создан файл: {e.Name}");
};

// Удаление файла
watcher.Deleted += (sender, e) =>
{
    Console.WriteLine($"Удален файл: {e.Name}");
};

// Изменение файла
watcher.Changed += (sender, e) =>
{
    Console.WriteLine($"Изменен файл: {e.Name}");
};

// Переименование файла
watcher.Renamed += (sender, e) =>
{
    Console.WriteLine($"Переименован: {e.OldName} -> {e.Name}");
};

// Ошибка
watcher.Error += (sender, e) =>
{
    Console.WriteLine($"Ошибка: {e.GetException().Message}");
};
```

### Лучшие практики

#### 1. Обработка исключений
```csharp
try
{
    string content = File.ReadAllText("file.txt");
}
catch (FileNotFoundException)
{
    Console.WriteLine("Файл не найден");
}
catch (UnauthorizedAccessException)
{
    Console.WriteLine("Нет доступа к файлу");
}
catch (IOException ex)
{
    Console.WriteLine($"Ошибка ввода-вывода: {ex.Message}");
}
```

#### 2. Использование using для ресурсов
```csharp
using (var stream = File.OpenRead("file.txt"))
using (var reader = new StreamReader(stream))
{
    string line;
    while ((line = reader.ReadLine()) != null)
    {
        Console.WriteLine(line);
    }
}
```

#### 3. Проверка существования файлов
```csharp
if (File.Exists("file.txt"))
{
    // Работа с файлом
}
else
{
    Console.WriteLine("Файл не существует");
}
```

#### 4. Безопасное удаление файлов
```csharp
try
{
    if (File.Exists("file.txt"))
    {
        File.Delete("file.txt");
    }
}
catch (Exception ex)
{
    Console.WriteLine($"Ошибка при удалении: {ex.Message}");
}
```

### Примеры использования

#### Поиск файлов по расширению
```csharp
public static string[] FindFilesByExtension(string directory, string extension)
{
    try
    {
        return Directory.GetFiles(directory, extension, SearchOption.AllDirectories);
    }
    catch (Exception ex)
    {
        Console.WriteLine($"Ошибка при поиске: {ex.Message}");
        return new string[0];
    }
}
```

#### Логирование изменений файлов
```csharp
public static void LogFileChange(string logFile, string eventType, string fileName)
{
    var logEntry = $"{DateTime.Now:yyyy-MM-dd HH:mm:ss} - {eventType}: {fileName}";
    File.AppendAllText(logFile, logEntry + Environment.NewLine);
}
```

#### Изменение атрибутов файлов
```csharp
public static void RemoveArchiveAttribute(string[] files)
{
    foreach (var file in files)
    {
        try
        {
            var attributes = File.GetAttributes(file);
            if ((attributes & FileAttributes.Archive) == FileAttributes.Archive)
            {
                File.SetAttributes(file, attributes & ~FileAttributes.Archive);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Ошибка при обработке {file}: {ex.Message}");
        }
    }
}
```

### Преимущества работы с файлами

1. **Постоянное хранение данных** - данные сохраняются между запусками программы
2. **Обмен данными** - возможность обмена данными между приложениями
3. **Логирование** - запись событий для отладки и мониторинга
4. **Конфигурация** - хранение настроек приложения
5. **Резервное копирование** - создание копий важных данных

### Недостатки

1. **Производительность** - операции с файлами медленнее операций с памятью
2. **Безопасность** - необходимость проверки прав доступа
3. **Синхронизация** - проблемы при одновременном доступе к файлу
4. **Обработка ошибок** - множество возможных исключений
5. **Размер файлов** - ограничения на размер файлов

### Типичные сценарии использования

#### Конфигурационные файлы
```csharp
// Чтение настроек
var config = File.ReadAllLines("config.txt")
    .Where(line => !line.StartsWith("#"))
    .ToDictionary(line => line.Split('=')[0], line => line.Split('=')[1]);
```

#### Лог-файлы
```csharp
// Запись лога
var logEntry = $"{DateTime.Now}: {message}";
File.AppendAllText("app.log", logEntry + Environment.NewLine);
```

#### Обработка данных
```csharp
// Чтение и обработка данных
var data = File.ReadAllLines("data.csv")
    .Skip(1) // пропуск заголовка
    .Select(line => line.Split(','))
    .Where(fields => fields.Length >= 3);
```

## Заключение

Работа с файлами является важной частью программирования, которая позволяет создавать приложения, способные сохранять и обрабатывать данные. Правильное использование файловых операций обеспечивает надежность, производительность и безопасность приложений. 